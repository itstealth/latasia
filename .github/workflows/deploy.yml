name: ğŸš€ Build & Deploy to VPS
on:  
  push:    
    branches:      
      - main
permissions:  
  contents: read  
  packages: write
jobs:  
  build-and-deploy:    
    runs-on: ubuntu-latest    
    steps:      
      - name: ğŸ“¥ Checkout Code        
        uses: actions/checkout@v4      
      
      - name: ğŸ³ Login to GHCR        
        uses: docker/login-action@v3        
        with:          
          registry: ghcr.io          
          username: ${{ github.actor }}          
          password: ${{ secrets.GITHUB_TOKEN }}      
      
      - name: ğŸ—ï¸ Build Docker Image        
        run: docker build -t ghcr.io/itstealth/latasia:latest .      
      
      - name: ğŸ“¤ Push Docker Image        
        run: docker push ghcr.io/itstealth/latasia:latest      
      
      # --- NEW TAILSCALE STEP ---
      - name: ğŸ›¡ï¸ Connect to Tailscale VPN
        uses: tailscale/github-action@v2
        with:
          oauth-client-id: ${{ secrets.TS_OAUTH_CLIENT_ID }}
          oauth-secret: ${{ secrets.TS_OAUTH_SECRET }}
          tags: tag:ci
      # --------------------------

      - name: ğŸš€ Deploy on VPS        
        uses: appleboy/ssh-action@v0.1.10        
        with:          
          host: ${{ secrets.SERVER_HOST }}          
          username: ${{ vars.SERVER_USER }}  # Assuming you put this in Variables, otherwise secrets.SERVER_USER        
          key: ${{ secrets.SERVER_SSH_KEY }}          
          port: 22          
          script: |            
            cd /var/www/latasisa            
            docker compose pull            
            docker compose up -d --remove-orphans            
            docker compose exec -T app php artisan migrate --force
